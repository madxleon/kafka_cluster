version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    hostname: zookeeper
    ports:
      - "2181:2181"
      - "2182:2182"
      - "2888:2888"
      - "3888:3888"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 10s
      retries: 3
    environment:
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_SECURE_CLIENT_PORT: 2182
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2      
      #ZOOKEEPER_SSL_KEYSTORE_LOCATION: /var/lib/zookeeper/keystore.jks
      #ZOOKEEPER_SSL_KEYSTORE_PASSWORD: confluent
      #ZOOKEEPER_SSL_KEY_PASSWORD: confluent
      #ZOOKEEPER_SSL_TRUSTSTORE_LOCATION: /var/lib/zookeeper/truststore.jks
      #ZOOKEEPER_SSL_TRUSTSTORE_PASSWORD: confluent
      #ZOOKEEPER_SSL_CLIENT_AUTH: need    
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/zookeeper/zookeeper_jaas.conf"
      #KAFKA_SASL_ENABLED_MECHANISMS: PLAIN 
      ZOOKEEPER_JAAS_OPTS: "-Djava.security.auth.login.config=/etc/zookeeper/zookeeper_jaas.conf"
      #ZOOKEEPER_SERVER_CNXNFACTORY: org.apache.zookeeper.server.NettyServerCnxnFactory
      #ZOOKEEPER_AUTH_PROVIDER_1: "org.apache.zookeeper.server.auth.SASLAuthenticationProvider"
      #ZOOKEEPER_AUTH_PROVIDER_2: "org.apache.zookeeper.server.auth.X509AuthenticationProvider"
    volumes:
      - ./zookeeper_jaas.conf:/etc/zookeeper/zookeeper_jaas.conf
      - ./keystore.jks:/var/lib/zookeeper/keystore.jks
      - ./truststore.jks:/var/lib/zookeeper/truststore.jks
      - ./zooclient.keystore.jks:/var/lib/zookeeper/zooclient.keystore.jks
      - ./zooclient.truststore.jks:/var/lib/zookeeper/zooclient.truststore.jks
      - ./zookeeper.conf:/etc/zookeeper/zookeeper.properties
      - ./zookeeper-client.conf:/etc/zookeeper/zookeeper-client.properties
    command: ["sh", "-c", "zookeeper-server-start /etc/zookeeper/zookeeper.properties"]
     
  create_scram_users:
    image: confluentinc/cp-kafka:latest    
    environment: 
      KAFKA_SSL_KEYSTORE_FILENAME: keystore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: keystore_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: truststore.jks
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: keystore_creds
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-512
      KAFKA_ADVERTISED_LISTENERS: SASL_SSL://kafka1:9091,SSL://kafka1:9081
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafkaserver_jaas.conf"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      BOOTSTRAP_SERVERS: kafka1:9091,kafka2:9092,kafka3:9093,kafka4:9094,kafka5:9095
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512mb
    depends_on:
      - zookeeper
    command: ["sh", "-c", "until echo ruok | nc -w 1 zookeeper 2181 | grep imok; do sleep 5; done && sh /etc/kafka/create_scram_users.sh"]
    volumes:
      - ./create_scram_users.sh:/etc/kafka/create_scram_users.sh
      - ./kafkaserver_jaas.conf:/etc/kafka/kafkaserver_jaas.conf
      - ./keystore.jks:/etc/kafka/secrets/keystore.jks
      - ./truststore.jks:/etc/kafka/secrets/truststore.jks
      - ./keystore_creds:/etc/kafka/secrets/keystore_creds
      - ./client.properties:/etc/kafka/client.properties

  kafka1:
    image: confluentinc/cp-kafka:latest
    hostname: kafka1
    healthcheck:
      test: ["CMD-SHELL", "ps augwwx | grep -q [S]upportedKafka"]
    depends_on:
      - create_scram_users
    ports:
      - "9091:9091"
    environment:
	  ZOOKEEPER_CLIENT_CNXN_SOCKET: "org.apache.zookeeper.ClientCnxnSocketNetty"
      ZOOKEEPER_SSL_CLIENT_ENABLE: "true"
      ZOOKEEPER_SSL_PROTOCOL: "TLSv1.2"
      ZOOKEEPER_SSL_KEYSTORE_LOCATION: "/etc/kafka/secrets/keystore.jks"
      ZOOKEEPER_SSL_KEYSTORE_PASSWORD: "confluent"
      ZOOKEEPER_SSL_TRUSTSTORE_LOCATION: "/etc/kafka/secrets/truststore.jks"
      ZOOKEEPER_SSL_TRUSTSTORE_PASSWORD: "confluent"
      ZOOKEEPER_CONNECT: "zookeeper:2182"
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.authorizer.AclAuthorizer
      KAFKA_SUPER_USERS: User:admin
      KAFKA_LISTENERS: SASL_SSL://kafka1:9091,SSL://kafka1:9081
      KAFKA_SSL_KEYSTORE_FILENAME: keystore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: keystore_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: truststore.jks
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_CLIENT_AUTH: none      
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-512
      KAFKA_ADVERTISED_LISTENERS: SASL_SSL://kafka1:9091,SSL://kafka1:9081
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafkaserver_jaas.conf"
	  -Djava.security.auth.login.config=/path/to/zookeeper_jaas.conf
      #KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_BROKER_ID: 1
      BOOTSTRAP_SERVERS: kafka1:9091,kafka2:9092,kafka3:9093,kafka4:9094,kafka5:9095
    volumes:
      - ./kafkaserver_jaas.conf:/etc/kafka/kafkaserver_jaas.conf
      - ./keystore.jks:/etc/kafka/secrets/keystore.jks
      - ./truststore.jks:/etc/kafka/secrets/truststore.jks
      - ./keystore_creds:/etc/kafka/secrets/keystore_creds
      - ./client.properties:/etc/kafka/client.properties

  kafka2:
    image: confluentinc/cp-kafka:latest
    hostname: kafka2
    healthcheck:
      test: ["CMD-SHELL", "ps augwwx | grep -q [S]upportedKafka"]
    depends_on:
      - create_scram_users
    ports:
      - "9092:9092"
    environment:
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.authorizer.AclAuthorizer
      KAFKA_SUPER_USERS: User:admin
      KAFKA_LISTENERS: SASL_SSL://kafka2:9092,SSL://kafka2:9082
      KAFKA_SSL_KEYSTORE_FILENAME: keystore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: keystore_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: truststore.jks
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_CLIENT_AUTH: required      
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-512
      KAFKA_ADVERTISED_LISTENERS: SASL_SSL://kafka2:9092,SSL://kafka2:9082
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafkaserver_jaas.conf"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_BROKER_ID: 2
      BOOTSTRAP_SERVERS: kafka1:9091,kafka2:9092,kafka3:9093,kafka4:9094,kafka5:9095
    volumes:
      - ./kafkaserver_jaas.conf:/etc/kafka/kafkaserver_jaas.conf
      - ./keystore.jks:/etc/kafka/secrets/keystore.jks
      - ./truststore.jks:/etc/kafka/secrets/truststore.jks
      - ./keystore_creds:/etc/kafka/secrets/keystore_creds
      - ./client.properties:/etc/kafka/client.properties

  kafka3:
    image: confluentinc/cp-kafka:latest
    hostname: kafka3
    healthcheck:
      test: ["CMD-SHELL", "ps augwwx | grep -q [S]upportedKafka"]
    depends_on:
      - create_scram_users
    ports:
      - "9093:9093"
    environment:
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.authorizer.AclAuthorizer
      KAFKA_SUPER_USERS: User:admin
      KAFKA_LISTENERS: SASL_SSL://kafka3:9093,SSL://kafka3:9083
      KAFKA_SSL_KEYSTORE_FILENAME: keystore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: keystore_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: truststore.jks
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_CLIENT_AUTH: required      
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-512
      KAFKA_ADVERTISED_LISTENERS: SASL_SSL://kafka3:9093,SSL://kafka3:9083
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafkaserver_jaas.conf"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_BROKER_ID: 3
      BOOTSTRAP_SERVERS: kafka1:9091,kafka2:9092,kafka3:9093,kafka4:9094,kafka5:9095
    volumes:
      - ./kafkaserver_jaas.conf:/etc/kafka/kafkaserver_jaas.conf
      - ./keystore.jks:/etc/kafka/secrets/keystore.jks
      - ./truststore.jks:/etc/kafka/secrets/truststore.jks
      - ./keystore_creds:/etc/kafka/secrets/keystore_creds
      - ./client.properties:/etc/kafka/client.properties

  kafka4:
    image: confluentinc/cp-kafka:latest
    hostname: kafka4
    healthcheck:
      test: ["CMD-SHELL", "ps augwwx | grep -q [S]upportedKafka"]
    depends_on:
      - create_scram_users
    ports:
      - "9094:9094"
    environment:
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.authorizer.AclAuthorizer
      KAFKA_SUPER_USERS: User:admin
      KAFKA_LISTENERS: SASL_SSL://kafka4:9094,SSL://kafka4:9084
      KAFKA_SSL_KEYSTORE_FILENAME: keystore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: keystore_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: truststore.jks
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_CLIENT_AUTH: required      
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-512
      KAFKA_ADVERTISED_LISTENERS: SASL_SSL://kafka4:9094,SSL://kafka4:9084
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafkaserver_jaas.conf"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_BROKER_ID: 4
      BOOTSTRAP_SERVERS: kafka1:9091,kafka2:9092,kafka3:9093,kafka4:9094,kafka5:9095
    volumes:
      - ./kafkaserver_jaas.conf:/etc/kafka/kafkaserver_jaas.conf
      - ./keystore.jks:/etc/kafka/secrets/keystore.jks
      - ./truststore.jks:/etc/kafka/secrets/truststore.jks
      - ./keystore_creds:/etc/kafka/secrets/keystore_creds
      - ./client.properties:/etc/kafka/client.properties

  kafka5:
    image: confluentinc/cp-kafka:latest
    hostname: kafka5
    healthcheck:
      test: ["CMD-SHELL", "ps augwwx | grep -q [S]upportedKafka"]
    depends_on:
      - create_scram_users
    ports:
      - "9095:9095"
    environment:
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.authorizer.AclAuthorizer
      KAFKA_SUPER_USERS: User:admin
      KAFKA_LISTENERS: SASL_SSL://kafka5:9095,SSL://kafka5:9085
      KAFKA_SSL_KEYSTORE_FILENAME: keystore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: keystore_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: truststore.jks
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: keystore_creds
      KAFKA_SSL_CLIENT_AUTH: required      
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-512
      KAFKA_ADVERTISED_LISTENERS: SASL_SSL://kafka5:9095,SSL://kafka5:9085
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafkaserver_jaas.conf"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_BROKER_ID: 5
      BOOTSTRAP_SERVERS: kafka1:9091,kafka2:9092,kafka3:9093,kafka4:9094,kafka5:9095
    volumes:
      - ./kafkaserver_jaas.conf:/etc/kafka/kafkaserver_jaas.conf
      - ./keystore.jks:/etc/kafka/secrets/keystore.jks
      - ./truststore.jks:/etc/kafka/secrets/truststore.jks
      - ./keystore_creds:/etc/kafka/secrets/keystore_creds
      - ./client.properties:/etc/kafka/client.properties
